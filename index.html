<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>File Upload</title>
</head>
<body>
    <h1>上传 YML 和 PNG 文件</h1>
    <input type="file" id="ymlFile" accept=".yml" />
    <input type="file" id="pngFile" accept=".png" />
    <button id="submit">提交</button>
    <div id="output"></div>
    
    <script>
        document.getElementById('submit').addEventListener('click', async () => {
            const ymlFileInput = document.getElementById('ymlFile');
            const pngFileInput = document.getElementById('pngFile');

            if (ymlFileInput.files.length === 0 || pngFileInput.files.length === 0) {
                alert('请上传 YML 和 PNG 文件!');
                return;
            }

            const ymlFile = ymlFileInput.files[0];
            const pngFile = pngFileInput.files[0];

            // 将文件读取为 Base64
            const ymlData = await readFileAsBase64(ymlFile);
            const pngData = await readFileAsBase64(pngFile);

            // 存储到 Local Storage
            localStorage.setItem('ymlData', ymlData);
            localStorage.setItem('pngData', pngData);

            // 发送 Base64 数据到后端
            const response = await fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ymlData: ymlData,
                    pngData: pngData
                })
            });
            const result = await response.json();
            const outputDiv = document.getElementById('output');

            if (response.ok) {
                outputDiv.innerHTML = `<p>${result.message}</p><p>First two bytes (hex): ${result.bytes}</p>`;
                
                // 创建自动下载 output.img
                const downloadLink = document.createElement('a');
                downloadLink.href = result.outputImgPath;
                downloadLink.download = 'output.img';
                downloadLink.style.display = 'none';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            } else {
                outputDiv.innerHTML = `<p style="color: red;">${result.error}</p>`;
            }
        });

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>