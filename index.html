<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>File Upload</title>
</head>
<body>
    <h1>上传 YML 和 PNG 文件</h1>
    <input type="file" id="ymlFile" accept=".yml" />
    <input type="file" id="pngFile" accept=".png" />
    <button id="submit">提交</button>
    <div id="output"></div>
    
    <script>
       // 将 img_buffer 转换为 Blob 并自动下载
       function downloadImage(imgBufferBase64, fileName) {
            // 将 img_bufferBase64 转换为 Blob 对象
            const binaryString = atob(imgBufferBase64.split(",")[1]);  // 解码 Base64
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const blob = new Blob([bytes], { type: 'application/octet-stream' });

            // 创建一个隐藏的下载链接并点击它
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }
        // 将 ArrayBuffer 数据下载为文件
        function downloadImageFromArrayBuffer(arrayBuffer, fileName) {
            const blob = new Blob([arrayBuffer], { type: 'application/octet-stream' });

            // 创建一个隐藏的下载链接并点击它
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }
        document.getElementById('submit').addEventListener('click', async () => {
            const ymlFileInput = document.getElementById('ymlFile');
            const pngFileInput = document.getElementById('pngFile');

            if (ymlFileInput.files.length === 0 || pngFileInput.files.length === 0) {
                alert('请上传 YML 和 PNG 文件!');
                return;
            }

            const ymlFile = ymlFileInput.files[0];
            const pngFile = pngFileInput.files[0];

            // 将文件读取为 Base64
            const ymlData = await readFileAsBase64(ymlFile);
            const pngData = await readFileAsBase64(pngFile);

            // 存储到 Local Storage
            localStorage.setItem('ymlData', ymlData);
            localStorage.setItem('pngData', pngData);

            // 发送 Base64 数据到后端
            const response = await fetch('/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ymlData: ymlData,
                    pngData: pngData
                })
            });
            const outputDiv = document.getElementById('output');

            if (response.ok) {
                const imgArrayBuffer = await response.arrayBuffer();  // 读取 ArrayBuffer 数据
                outputDiv.innerHTML = `<p>Files processed successfully!</p>`;
                
                // 下载 ArrayBuffer 格式的图像
                downloadImageFromArrayBuffer(imgArrayBuffer, 'output.img');
            } else {
                const result = await response.json();
                outputDiv.innerHTML = `<p style="color: red;">${result.stack}</p>`;
            }
        });

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        
    </script>
</body>
</html>